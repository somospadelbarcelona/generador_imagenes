<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Sincronizaci√≥n de Jugadores (Excel)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-init.js"></script>
</head>

<body style="font-family: 'Outfit', sans-serif; background: #0a0a0a; color: white; padding: 40px; text-align: center;">
    <div style="max-width: 800px; margin: 0 auto;">
        <h1 style="color: #ccff00; letter-spacing: 2px;">SINCRONIZACI√ìN DE G√âNERO</h1>
        <p style="color: #888;">Actualizaci√≥n masiva de la base de datos basada en @[jugadores.xlsx]</p>

        <div id="status"
            style="background: #151515; border: 1px solid #333; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; font-family: monospace; max-height: 400px; overflow-y: auto;">
            Esperando orden de inicio...
        </div>

        <button onclick="processExcel('jugadores.xlsx')"
            style="background: #ccff00; color: black; border: none; padding: 15px 35px; font-weight: 900; border-radius: 8px; cursor: pointer; font-size: 1rem; box-shadow: 0 0 20px rgba(204, 255, 0, 0.2);">
            üöÄ APLASTAR E IMPORTAR (CON G√âNERO)
        </button>

        <p style="margin-top: 20px; font-size: 0.8rem; color: #555;">Este proceso eliminar√° los jugadores actuales
            (excepto Alex) e importar√° los del Excel con sus categor√≠as correctas.</p>
    </div>

    <script>
        async function processExcel(filePath) {
            const status = document.getElementById('status');
            status.innerHTML = "üõ†Ô∏è Abriendo archivo Excel...";

            try {
                const response = await fetch(filePath);
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });

                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                status.innerHTML = `‚úÖ Excel le√≠do. Registros: ${jsonData.length}<br>`;

                // 1. WIPE DATA (KEEP ALEX)
                status.innerHTML += "üßπ Limpiando base de datos actual...<br>";
                const allPlayers = await window.FirebaseDB.players.getAll();
                let deletedCount = 0;
                for (const p of allPlayers) {
                    if (p.phone !== '649219350') {
                        await window.FirebaseDB.players.delete(p.id);
                        deletedCount++;
                    }
                }
                status.innerHTML += `üóëÔ∏è Eliminados ${deletedCount} registros antiguos.<br>`;

                // 2. IMPORT NEW DATA
                status.innerHTML += "üì• Iniciando importaci√≥n con g√©nero...<br>";
                let importCount = 0;
                for (const row of jsonData) {
                    // Normalize data
                    const rawName = row['Nombre y apellidos'] || row['Nombre'] || "Sin Nombre";
                    const rawPhone = (row['N√∫mero de tel√©fono'] || row['Tel√©fono'] || "").toString().replace(/\D/g, '');
                    const rawLevel = row['NIVEL'] || row['Nivel'] || "3.5";

                    // GENDER LOGIC
                    let gender = "M"; // Default
                    const genderRaw = (row['G√©nero'] || row['Genero'] || "").toString().toUpperCase();
                    if (genderRaw.includes("CHICA") || genderRaw === "F" || genderRaw.includes("FEM")) {
                        gender = "F";
                    }

                    if (rawPhone.length < 9) continue;

                    const uid = "u_" + rawPhone;
                    const userData = {
                        id: uid,
                        name: rawName.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                        phone: rawPhone,
                        gender: gender,
                        password: "PADEL26",
                        level: rawLevel.toString(),
                        self_rate_level: rawLevel.toString(),
                        role: "player",
                        status: "active",
                        membership: "somospadel_bcn",
                        matches_played: 0,
                        win_rate: 0,
                        createdAt: new Date().toISOString()
                    };

                    try {
                        await window.db.collection('players').doc(uid).set(userData);
                        status.innerHTML += `<span style="color:#69f0ae">‚úÖ [${gender}] ${userData.name}</span><br>`;
                        importCount++;
                    } catch (e) {
                        status.innerHTML += `<span style="color:red">‚ùå Error ${userData.name}: ${e.message}</span><br>`;
                    }
                    status.scrollTop = status.scrollHeight;
                }

                status.innerHTML += `<br><h2 style="color:#ccff00">üèÅ ¬°PROCESO COMPLETADO!</h2>`;
                status.innerHTML += `Total importados: ${importCount} jugadores con g√©nero asignado.`;

            } catch (err) {
                status.innerHTML += `<br><span style="color:red">‚ùå ERROR CR√çTICO: ${err.message}</span>`;
                console.error(err);
            }
        }
    </script>
</body>

</html>